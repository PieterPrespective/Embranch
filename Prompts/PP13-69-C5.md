- IssueID = PP13-69-C5
- Please read 'Prompts/BasePrompt.md' first for general context
- Please read 'Prompts/PP13-69.md' and read from the PP13-69 'chroma-feat-design-planning-mcp' collection for the main architectural overhaul context
- Please read 'Prompts/PP13-69-C1.md', 'Prompts/PP13-69-C2.md', 'Prompts/PP13-69-C3.md', and 'Prompts/PP13-69-C4.md' for previous cleanup work; also check their respective 'chroma-feat-design-planning-mcp' collections

## Context: BranchSwitchingIntegrationTests Post PP13-69 Architecture

The PP13-69 architectural overhaul (moving sync state from Dolt to SQLite) has left the BranchSwitchingIntegrationTests.cs in a state of **architectural incompatibility**. Unlike previous test fixes that only required service registration updates, these tests require **fundamental architectural modernization** to align with PP13-69 patterns.

## Previous Work Completed:
- PP13-69 Phases 1-4: Complete architectural migration to SQLite-based sync state  
- PP13-69-C1: Simplified ProcessCheckoutAsync, eliminated defensive programming
- PP13-69-C2: Additional refactoring and cleanup
- PP13-69-C3: Test suite updates and validation
- PP13-69-C4: Fixed CollectionSyncIntegrationTests and ProductionInitializationIntegrationTests service registrations

## Current Analysis: BranchSwitchingIntegrationTests.cs

### Critical Problems Identified:

#### 1. **MAJOR ARCHITECTURAL INCOMPATIBILITY:**

**Manual Service Construction vs DI Pattern:**
```csharp
// ‚ùå CURRENT (INCOMPATIBLE): Manual construction bypassing DI optimization
var deletionTracker = new SqliteDeletionTracker(
    loggerFactory.CreateLogger<SqliteDeletionTracker>(),
    serverConfig.Value);
_syncManager = new SyncManagerV2(deletionTracker, deletionTracker, ...);
```

**Should Follow:**
```csharp
// ‚úÖ REQUIRED: DI container pattern (like CollectionSyncIntegrationTests)
services.AddSingleton<IDeletionTracker, SqliteDeletionTracker>();
services.AddSingleton<ISyncStateTracker>(sp => sp.GetRequiredService<IDeletionTracker>() as ISyncStateTracker);
_syncManager = _serviceProvider.GetRequiredService<ISyncManagerV2>();
```

#### 2. **DEPRECATED SERVICE DEPENDENCIES:**

**Lines 26-27, 79-80: Legacy Services:**
```csharp
// ‚ùå OBSOLETE: These services may be incompatible with PP13-69
private ChromaToDoltSyncer _chromaSyncer = null!;
private ChromaToDoltDetector _chromaDetector = null!;
```

**Lines Throughout Tests: Deprecated Workflow:**
```csharp
// ‚ùå LEGACY PATTERN: External staging calls
await _chromaSyncer.StageLocalChangesAsync("collection1");
await _syncManager.ProcessCommitAsync("commit message");

// ‚úÖ PP13-69 PATTERN: Internal staging within SyncManagerV2
await _syncManager.ProcessCommitAsync("commit message");  // Handles staging internally
```

#### 3. **SEVERE PERFORMANCE ISSUES:**

**Timeout Evidence:**
- Single test timeout at 46+ seconds (should be <10 seconds)
- ChromaDB operations taking 2.7+ seconds per collection (should be milliseconds)
- Tests hanging during document count verification

**Root Cause:** Incompatible service construction and deprecated workflow patterns causing blocking operations.

### Test Relevance Assessment:

#### üî¥ **CRITICAL - Must Fix (Core Functionality):**

**1. TestBranchSwitchingValidation** 
- **Purpose:** Core branch switching with uncommitted change handling modes (abort/commit_first/carry/reset_first)
- **Critical Value:** Tests fundamental `DoltCheckoutTool` functionality essential for PP13-69
- **Current Issue:** Performance timeout, architectural incompatibility

**2. PP13_68_BranchSwitchingWithContentValidation**
- **Purpose:** Content-hash verification during branch switching (prevents false positive sync skips)
- **Critical Value:** Validates PP13-68 bug fix doesn't regress
- **Current Issue:** Heavy reliance on deprecated service patterns

**3. TestUncommittedChangesHandling**
- **Purpose:** Validates all uncommitted change modes work correctly
- **Critical Value:** Core checkout tool functionality validation
- **Current Issue:** Architectural incompatibility

#### üü° **VALUABLE - Fix if Time Permits:**

**4. TestComplexDocumentLifecycleAcrossBranches**
- **Purpose:** Multi-branch document lifecycle validation
- **Value:** Complex integration testing
- **Issue:** Heavy use of deprecated `_chromaSyncer` calls

**5. PP13_68_RapidBranchSwitchingContentStressTest**
- **Purpose:** Performance testing under rapid branch switching
- **Value:** Ensures PP13-68 content verification performs well under stress
- **Issue:** Will timeout given current performance problems

#### ‚ùå **OBSOLETE - Keep Disabled:**

**6. TestMultiUserBranchDevelopmentWorkflow**
- **Status:** Already disabled with `[Ignore]` attribute (Line 143)
- **Reason:** Too complex, uses deprecated patterns, simulates manual multi-user workflows
- **Action:** Keep disabled - outside scope of unit/integration testing

## Assignment: Modernize BranchSwitchingIntegrationTests for PP13-69

### Required Actions:

#### **Phase 1: Architectural Modernization (CRITICAL)**

**1. Convert to Dependency Injection Pattern:**
- Replace manual service construction (Lines 72-96) with ServiceCollection/ServiceProvider pattern
- Follow successful patterns from CollectionSyncIntegrationTests.cs and ProductionInitializationIntegrationTests.cs
- Ensure proper dual-interface registration for `SqliteDeletionTracker`

**2. Eliminate Deprecated Service Dependencies:**
```csharp
// ‚ùå REMOVE: Lines 26-27, 79-80
private ChromaToDoltSyncer _chromaSyncer = null!;
private ChromaToDoltDetector _chromaDetector = null!;

// ‚úÖ KEEP: Modern PP13-69 services
private SyncManagerV2 _syncManager = null!;
private DoltCheckoutTool _checkoutTool = null!;
```

**3. Update Staging Workflow Pattern:**
```csharp
// ‚ùå REPLACE: External staging pattern (throughout tests)
await _chromaSyncer.StageLocalChangesAsync("collection1");
await _syncManager.ProcessCommitAsync("commit message");

// ‚úÖ WITH: PP13-69 internal staging pattern  
await _syncManager.ProcessCommitAsync("commit message");  // Handles staging internally
```

#### **Phase 2: Service Registration Fix (IMMEDIATE)**

**Setup Method (Lines 30-101):**
```csharp
// Add to service collection (following CollectionSyncIntegrationTests pattern):
services.AddSingleton<IDeletionTracker, SqliteDeletionTracker>();
services.AddSingleton<ISyncStateTracker>(sp => sp.GetRequiredService<IDeletionTracker>() as ISyncStateTracker);
services.AddSingleton<ICollectionChangeDetector, CollectionChangeDetector>();
services.AddSingleton<ISyncManagerV2, SyncManagerV2>();
services.AddTransient<DoltCheckoutTool>();
```

#### **Phase 3: Configuration Modernization**

**Update ServerConfiguration (Lines 62-66):**
```csharp
// ‚úÖ MODERN PP13-69 PATTERN:
var serverConfig = Options.Create(new ServerConfiguration 
{ 
    ChromaDataPath = chromaDataPath,
    ChromaMode = "persistent", 
    DataPath = _tempDir
});
```

#### **Phase 4: Test-Specific Fixes**

**1. TestBranchSwitchingValidation (Lines 304-415):**
- Remove all `_chromaSyncer.StageLocalChangesAsync()` calls
- Use `_syncManager.ProcessCommitAsync()` directly for staging and committing
- Verify checkout tool integration with new service architecture

**2. PP13_68_BranchSwitchingWithContentValidation (Lines 636-727):**
- Update content validation workflow to use PP13-69 patterns
- Ensure content-hash verification still works correctly
- Remove deprecated service calls

**3. TestUncommittedChangesHandling (Lines 534-628):**
- Validate all checkout modes (abort/commit_first/carry/reset_first) work with PP13-69
- Update workflow to use modern service patterns

#### **Phase 5: Performance Optimization**

**1. Service Lifecycle Management:**
- Proper service disposal in TearDown
- Efficient service provider creation/destruction
- Follow cleanup patterns from working test suites

**2. Timeout Management:**
- Add appropriate test timeouts for integration tests
- Optimize ChromaDB operation patterns
- Reduce unnecessary service overhead

### Test Priority for Implementation:

#### **IMMEDIATE (Phase 1):**
1. **TestBranchSwitchingValidation** - Core checkout functionality
2. **TestUncommittedChangesHandling** - Essential checkout modes

#### **HIGH PRIORITY (Phase 2):**  
3. **PP13_68_BranchSwitchingWithContentValidation** - Critical regression prevention

#### **IF TIME PERMITS (Phase 3):**
4. **TestComplexDocumentLifecycleAcrossBranches** - Complex integration validation
5. **PP13_68_RapidBranchSwitchingContentStressTest** - Performance validation

#### **IGNORE:**
6. **TestMultiUserBranchDevelopmentWorkflow** - Keep disabled (too complex, deprecated patterns)

### Success Criteria:

1. ‚úÖ All active tests (5 total, excluding disabled) pass within reasonable time (<10 seconds each)
2. ‚úÖ Service registration follows PP13-69 dual-interface pattern correctly  
3. ‚úÖ No references to deprecated `ChromaToDoltSyncer`/`ChromaToDoltDetector` services
4. ‚úÖ Staging workflow uses `SyncManagerV2` internal methods, not external staging calls
5. ‚úÖ Branch switching functionality validates correctly post-PP13-69
6. ‚úÖ Content-hash verification (PP13-68) continues working in new architecture
7. ‚úÖ All checkout modes (abort/commit_first/carry/reset_first) function properly
8. ‚úÖ Performance issues resolved (no timeouts, efficient operations)

### Why These Tests Matter:

**BranchSwitchingIntegrationTests** validates **critical functionality** that's essential for PP13-69:

- **Branch Switching**: Core Git workflow functionality
- **Checkout Tool Integration**: Validates `DoltCheckoutTool` works with `SyncManagerV2`
- **Uncommitted Change Handling**: Essential for user workflow safety
- **Content Verification**: Ensures PP13-68 content-hash fixes work in branch switching context
- **SQLite Sync State**: Validates sync state tracking works correctly across branches

These tests are **NOT obsolete** - they provide **essential integration testing** for core functionality, but require **significant architectural modernization** to work with PP13-69 service patterns.

### Implementation Notes:

1. **Start with service registration fix** - This will resolve the primary blocking issue
2. **Remove deprecated services gradually** - Replace `_chromaSyncer` calls one test at a time
3. **Follow working patterns** - Use CollectionSyncIntegrationTests and ProductionInitializationIntegrationTests as templates
4. **Validate each fix independently** - Run tests individually to ensure each modernization works
5. **Performance monitoring** - Track test execution times to ensure optimizations are effective

### Expected Outcome:

After completing this assignment, BranchSwitchingIntegrationTests should provide comprehensive validation of branch switching operations with the PP13-69 architecture, ensuring that core Git workflow functionality works correctly with SQLite-based sync state tracking while maintaining the performance and reliability expectations of the modernized system.