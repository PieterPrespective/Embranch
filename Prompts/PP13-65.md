- IssueID = PP13-65
- Please read 'Prompts/BasePrompt.md' first for general context
- **CRITICAL MCP TOOL FAILURE**: The PreviewDoltMergeTool has fundamental data integrity and usability flaws that prevent users from making informed merge decisions, as documented in the field analysis report 'Examples/260104_mergepreviewtoolreview.md'

## Issue Context and Discovery

- This issue was discovered during field testing of the MergePreviewTool and confirmed through analysis of:
	- The PreviewDoltMergeTool implementation at `Tools/PreviewDoltMergeTool.cs`
	- The ConflictAnalyzer implementation at `Services/ConflictAnalyzer.cs` (specifically lines 472-482, 218-303)
	- The MergeModels definitions at `Models/MergeModels.cs`
	- Evidence from field testing showing empty/incorrect data in critical fields
	- User inability to understand merge conflicts or make informed decisions
- The tool fails to provide essential information needed for merge decisions, potentially leading to data loss or inappropriate merge choices

## Technical Root Cause Analysis

### Primary Issue: Placeholder Implementation in Critical Methods

The `ConflictAnalyzer.GenerateMergePreview` method at lines 472-482 contains only placeholder data:

```csharp
private async Task<MergePreviewInfo> GenerateMergePreview(string sourceBranch, string targetBranch)
{
    // This would analyze the diff between branches to provide statistics
    // For now, return placeholder data
    return new MergePreviewInfo
    {
        DocumentsAdded = 0,      // ❌ ALWAYS ZERO - No real analysis
        DocumentsModified = 0,   // ❌ ALWAYS ZERO - No real analysis  
        DocumentsDeleted = 0,    // ❌ ALWAYS ZERO - No real analysis
        CollectionsAffected = 1  // ❌ HARDCODED - Not calculated
    };
}
```

**The Problem**: This method is supposed to analyze changes between branches but returns only hardcoded placeholder values.

### Secondary Issues

1. **Empty Document Identification**: `ParseSingleConflictElement` method (lines 272-303) struggles to extract document IDs and collection names from Dolt's conflict JSON, often resulting in empty strings
2. **No Content Comparison**: The system provides no mechanism to show users actual content differences between conflicting versions
3. **Incomplete Field Conflict Analysis**: The `GetFieldConflicts` method is not properly implemented to provide detailed field-level conflict information
4. **Missing Resolution Impact Preview**: No functionality to show users what each resolution option would produce

### Failure Scenario Example

1. **User Scenario**: Branches have identical document counts but different content
2. **Expected**: Tool shows specific documents with conflicts, content differences, and resolution previews
3. **Actual Result**:
   - `document_id`: "" (empty)
   - `collection`: "" (empty)  
   - `field_conflicts`: [] (empty array)
   - `changes_preview`: All zeros regardless of actual changes
4. **Impact**: User cannot identify which documents conflict or understand the nature of conflicts

## Impact on User Decision-Making

This tool failure violates critical requirements for merge operations:
- Users cannot identify which specific documents are conflicting
- No visibility into actual content differences between branches
- No preview of what resolution options would produce
- Misleading change statistics suggest no changes when conflicts exist
- Silent failures make merge decisions potentially destructive

## Assignment Requirements

### Phase 1: Core Data Analysis Implementation

1. **Implement Real Branch Difference Analysis**:
   - Replace `GenerateMergePreview` placeholder with actual Dolt diff analysis
   - Use `dolt diff` commands to calculate real document added/modified/deleted counts
   - Properly identify affected collections from actual diff data
   - Add comprehensive logging for diff analysis operations

2. **Fix Document/Collection Identification**:
   - Enhance `ParseSingleConflictElement` to properly extract document IDs and collection names
   - Add fallback strategies for different Dolt conflict JSON formats
   - Implement robust parsing that handles edge cases and malformed data
   - Add validation to ensure critical fields are never empty

3. **Implement Content Comparison**:
   - Add `GetContentComparison` method to show actual document content differences
   - Provide base, source, and target content for each conflicted document
   - Implement content diff highlighting to show exactly what changed
   - Support both full content and change-only comparison modes

### Phase 2: Resolution Preview and Decision Support

4. **Implement Resolution Impact Preview**:
   - Create `GenerateResolutionPreview` method to show outcome of each resolution option
   - For "keep_ours": Show what content would be retained
   - For "keep_theirs": Show what content would be accepted
   - For "auto_merge": Show proposed merged content and confidence level
   - Include warnings about potential data loss for each option

5. **Enhanced Field-Level Conflict Analysis**:
   - Properly implement `GetFieldConflicts` to identify specific field differences
   - Provide detailed field-by-field comparison (content, metadata, timestamps)
   - Support field-level resolution options where appropriate
   - Add conflict context showing what changed in each branch

### Phase 3: Comprehensive Integration and Testing

6. **Implement Branch Comparison Analysis**:
   - Add comprehensive branch-to-branch comparison functionality
   - Identify documents unique to source branch, target branch, or modified in both
   - Calculate proper statistics for all change types
   - Provide clear summary of merge impact

7. **Create Integration Tests**:
   - Test with real Dolt repositories containing known conflicts
   - Verify document identification works correctly
   - Test content comparison accuracy
   - Validate resolution preview functionality
   - Test edge cases (empty branches, identical content, etc.)

8. **Update Model Definitions**:
   - Enhance `MergeModels.cs` to support new data structures for content comparison
   - Add models for resolution previews and branch comparisons
   - Ensure backward compatibility with existing tool interfaces

## Success Criteria

- [ ] PreviewDoltMerge returns accurate document IDs and collection names for all conflicts
- [ ] Change statistics correctly reflect actual differences between branches  
- [ ] Users can see actual content differences for conflicted documents
- [ ] Resolution options include previews showing the outcome of each choice
- [ ] Field-level conflicts are properly identified and detailed
- [ ] Branch comparison provides comprehensive overview of all changes
- [ ] All existing tool interfaces remain compatible
- [ ] Comprehensive integration tests demonstrate correct functionality

## Testing Validation Scenarios

1. **Same Count, Different Content**:
   - Create branches with identical document counts but different content
   - Verify tool correctly identifies conflicts and shows content differences
   - Test that resolution previews accurately show outcome options

2. **Multi-Collection Conflicts**:
   - Test with conflicts across multiple collections
   - Verify collection identification and per-collection conflict analysis
   - Test branch comparison with complex multi-collection scenarios

3. **Field-Level Resolution**:
   - Create conflicts affecting only specific fields (content vs metadata)
   - Test field-level conflict identification and resolution options
   - Verify field merge capabilities work correctly

4. **Resolution Preview Accuracy**:
   - Test each resolution option (keep_ours, keep_theirs, auto_merge, custom)
   - Verify previews accurately represent the outcome of each choice
   - Test confidence scoring for auto-merge suggestions

## Implementation Architecture

### Core Components to Enhance

1. **ConflictAnalyzer.cs**: 
   - Replace placeholder `GenerateMergePreview` implementation
   - Enhance conflict parsing and document identification
   - Add content comparison and resolution preview methods

2. **PreviewDoltMergeTool.cs**:
   - Enhance response structure to include new data
   - Add support for detailed content comparison requests
   - Implement comprehensive error handling for analysis failures

3. **MergeModels.cs**:
   - Add new model classes for content comparison data
   - Enhance existing models to support resolution previews
   - Add validation attributes to ensure data integrity

### Integration Points

- Must work with existing `IDoltCli` interface for repository operations
- Should integrate with `ISyncManagerV2` for local change detection
- Must maintain compatibility with `ExecuteDoltMergeTool` for resolution execution
- Should provide data compatible with existing MCP tool response formats

## Priority and Severity

**CRITICAL - USER EXPERIENCE AND DATA INTEGRITY**
- This issue prevents users from making informed merge decisions
- Could lead to accidental data loss or inappropriate merge choices
- Affects all users performing merge operations with conflicts
- Tool is essentially non-functional for its primary purpose

## Related Documentation

- Review field analysis in 'Examples/260104_mergepreviewtoolreview.md' for specific user impact details
- Consider integration with existing merge tools in `Tools/ExecuteDoltMergeTool.cs`
- Ensure compatibility with the bi-directional sync architecture from previous PP13-37 work
- Align with error handling patterns established in other MCP tools

## Expected Deliverables

1. **Enhanced ConflictAnalyzer.cs**: Real branch diff analysis and content comparison
2. **Updated PreviewDoltMergeTool.cs**: Comprehensive response data and error handling
3. **Extended MergeModels.cs**: New models supporting enhanced functionality
4. **Integration Tests**: Comprehensive test suite validating all functionality
5. **Documentation**: Updated tool documentation with new capabilities
6. **Performance Analysis**: Ensure enhanced analysis doesn't significantly impact tool response times

## Implementation Notes

- The solution should provide incremental value - implement core fixes first, then enhance
- Preserve existing tool interface for backward compatibility  
- Consider adding configuration options for detail level (summary vs full analysis)
- Add comprehensive logging to aid in debugging complex merge scenarios
- Consider performance implications of detailed diff analysis for large repositories
- Implement proper error handling to gracefully degrade when Dolt operations fail

## Additional Investigation Notes

Based on code analysis, the following specific methods need implementation:

1. **`GenerateMergePreview`**: Currently returns hardcoded zeros - needs real Dolt diff analysis
2. **`GetFieldConflicts`**: Referenced but implementation unclear - needs proper field-level analysis  
3. **`ParseSingleConflictElement`**: Struggles with document/collection identification - needs robust parsing
4. **Content comparison methods**: Completely missing - needs new implementation
5. **Resolution preview methods**: Missing - needs new architecture for showing resolution outcomes

The tool architecture is sound, but critical implementation details are incomplete or placeholder-based, making the tool unusable for its intended purpose.