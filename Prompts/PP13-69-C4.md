- IssueID = PP13-69-C4
- Please read 'Prompts/BasePrompt.md' first for general context
- Please read 'Prompts/PP13-69.md' and read from the PP13-69 'chroma-feat-design-planning-mcp' collection for the main architectural overhaul context
- Please read 'Prompts/PP13-69-C1.md', 'Prompts/PP13-69-C2.md', and 'Prompts/PP13-69-C3.md' for previous cleanup work; also check their respective 'chroma-feat-design-planning-mcp' collections

## Context: Test Suite Maintenance Post PP13-69

The PP13-69 architectural overhaul (moving sync state from Dolt to SQLite) has left several test suites in various states of compatibility. This assignment focuses on resolving failures in `CollectionSyncIntegrationTests.cs` which, unlike obsolete tests, provides valuable collection-level operation validation that remains relevant.

## Previous Work Completed:
- PP13-69 Phases 1-4: Complete architectural migration to SQLite-based sync state
- PP13-69-C1: Simplified ProcessCheckoutAsync, eliminated defensive programming
- PP13-69-C2: Additional refactoring and cleanup
- PP13-69-C3: Test suite updates and validation
- Removed obsolete test: `EmptyRepositoryFallbackIssuesTests.cs` (tested eliminated problems)
- Fixed teardown issues in PP13-69 Phase 4 validation tests

## Current Analysis: CollectionSyncIntegrationTests.cs

### Test Failure Root Cause:
```
System.InvalidOperationException: Unable to resolve service for type 'DMMS.Services.ISyncStateTracker' 
while attempting to activate 'DMMS.Services.SyncManagerV2'
```

### Key Findings:

#### 1. Service Registration Issue (Primary Failure):
- **Current Registration (Line 157):** Only registers `IDeletionTracker`
- **Required:** Both `IDeletionTracker` AND `ISyncStateTracker` 
- **Solution:** SqliteDeletionTracker implements both interfaces, needs dual registration

#### 2. Test Relevance Assessment:
- **PRESERVED VALUE:** Collection operations are orthogonal to PP13-69 sync state changes
- **CRITICAL FUNCTIONALITY:** Tests validate collection deletion, rename, and metadata updates
- **NO ARCHITECTURAL CONFLICTS:** Tests don't rely on obsolete `chroma_sync_state` patterns

#### 3. Collection Operations Still Valid:
- `SyncCollectionChangesAsync()` method exists in SyncManagerV2 (Line 1674)
- `CollectionSyncResult` class properly defined in ISyncManagerV2.cs (Line 317)
- Collection tracking via SqliteDeletionTracker remains unchanged by PP13-69

## Assignment: Fix CollectionSyncIntegrationTests.cs

### Required Actions:

#### 1. Fix Service Registration (Lines 156-159):
```csharp
// CURRENT (BROKEN):
services.AddSingleton<IDeletionTracker, SqliteDeletionTracker>();

// REQUIRED FIX:
services.AddSingleton<IDeletionTracker, SqliteDeletionTracker>();
services.AddSingleton<ISyncStateTracker>(sp => sp.GetRequiredService<IDeletionTracker>() as ISyncStateTracker);
// OR alternatively:
services.AddSingleton<SqliteDeletionTracker>();
services.AddSingleton<IDeletionTracker>(sp => sp.GetRequiredService<SqliteDeletionTracker>());
services.AddSingleton<ISyncStateTracker>(sp => sp.GetRequiredService<SqliteDeletionTracker>());
```

#### 2. Verify Schema Compatibility:
- Ensure collections table structure matches current expectations
- Verify documents table foreign key relationships
- No `chroma_sync_state` table references (removed by PP13-69)

#### 3. Update Test Expectations:
- Confirm ChromaDeleteCollectionTool integration
- Confirm ChromaModifyCollectionTool integration  
- Verify cascade deletion behavior for documents

#### 4. Fix Teardown Pattern:
- Follow pattern from PP13-69_Phase4_ValidationTests.cs
- Use proper SQLite cleanup methods instead of file deletion
- Handle database locking gracefully

### Test Coverage to Validate:

1. **EndToEnd_CollectionDeletionWorkflow_ShouldTrackAndSyncCorrectly**
   - Collection deletion tracking via tool
   - Cascade document deletion
   - Sync to Dolt and cleanup

2. **EndToEnd_CollectionRenameWorkflow_ShouldTrackAndSyncCorrectly**
   - Collection rename tracking
   - Document collection_name updates
   - Metadata preservation

3. **EndToEnd_ProcessCommitAsync_WithCollectionChanges_ShouldIncludeInCommit**
   - Collection changes in commit workflow
   - Automatic sync during commit

4. **EndToEnd_MultipleCollectionOperations_ShouldProcessAllCorrectly**
   - Mixed deletion and rename operations
   - Batch processing correctness

5. **CollectionChangeDetector_ShouldDetectOrphanedCollections**
   - Orphaned collection detection
   - HasPendingChanges accuracy

### Success Criteria:

1. ✅ All 5 tests in CollectionSyncIntegrationTests.cs pass
2. ✅ Service registration properly handles dual interface implementation
3. ✅ No references to obsolete `chroma_sync_state` table
4. ✅ Teardown handles SQLite database locking gracefully
5. ✅ Collection operations (delete, rename, update) work end-to-end

### Why These Tests Matter:

Unlike `EmptyRepositoryFallbackIssuesTests.cs` which tested eliminated problems, CollectionSyncIntegrationTests validates **active functionality** that remains critical:

- **Collection Management**: Core data organization feature
- **Tool Integration**: CLI tools for collection operations
- **Cascade Operations**: Maintains referential integrity
- **Change Detection**: Identifies orphaned/modified collections

These operations are **orthogonal to PP13-69's sync state changes** and provide essential integration testing for collection-level workflows.

### Implementation Notes:

1. Start with minimal service registration fix
2. Run tests individually to verify each workflow
3. Only modify schema creation if tests reveal incompatibilities
4. Preserve existing test logic - the workflows remain valid
5. Document any additional PP13-69 compatibility issues discovered

### Expected Outcome:

After completing this assignment, the CollectionSyncIntegrationTests suite should provide robust validation of collection management operations, ensuring that PP13-69's architectural changes didn't break collection-level functionality while properly integrating with the new SQLite-based sync state tracking.