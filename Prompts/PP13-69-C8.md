- IssueID = PP13-69-C8
- Please read 'Prompts/BasePrompt.md' first for general context
- Critical document ID selection issue identified: ChromaDB operations fail silently when document IDs don't match the chunk ID pattern, causing data integrity issues and test failures across the system.
- For context please read:
	- The PP13-69 architecture overview in 'Prompts/pp13-69.md' - the foundational design for SQLite sync state architecture
	- The PP13-69-C7 investigation logged in the chroma design planning database - discovery of document ID mismatch causing test failures
	- The test failure analysis showing doc3 deletion failing due to ID mismatch (doc3 vs doc3_chunk_0)
	- The chunking implementation in DocumentConverterV2.cs that creates the _chunk_N pattern
- This assignment specifically focuses on implementing a robust document ID selection system that handles chunk-based storage transparently, ensuring all document operations work correctly regardless of whether the base document ID or chunk ID is specified:

## **Root Cause Analysis - Document ID Selection Mismatch**

### **Issue: Chunk ID Pattern Not Handled in Document Operations (Critical)**
**Discovery**: `TestComplexDocumentLifecycleAcrossBranches` fails because doc3 isn't deleted
**Problem**: Test calls `DeleteDocumentsAsync("alpha", ["doc3"])` but document is stored as `doc3_chunk_0`
**Impact**: Silent failures in DeleteDocuments, UpdateDocuments, and GetDocuments operations
**Root Cause**: ChromaDB stores documents with chunk IDs (`docId_chunk_N`) but operations expect exact ID matches

### **Chunking Architecture Analysis:**
1. **Storage Pattern**: Documents are chunked for embedding optimization
   - Single document becomes multiple chunks: `doc1` → [`doc1_chunk_0`, `doc1_chunk_1`, ...]
   - Chunk size: 512 characters with 50 character overlap (configurable)
   - Each chunk has metadata including `chunk_index` and `total_chunks`

2. **Current Behavior**: 
   - Operations require exact ID match (including `_chunk_N` suffix)
   - No automatic expansion of base document ID to all chunks
   - Silent failures when IDs don't match exactly

3. **Affected Operations**:
   - `DeleteDocumentsAsync`: Fails to delete all chunks when given base ID
   - `UpdateDocumentsAsync`: Only updates specific chunks, not entire document - Also note that updating a document by a significant length (add or remove) will change the number of chunks that should exist (arguably updating a document should rechunk it entirely)
   - `GetDocumentsAsync`: May miss chunks when querying by base ID - please also add the functionality to get a full document unchunked (merges all chunks back to the original document, removes the overlap - will need an override parameter)

## **Assignment Objectives**

### **Primary Goals:**
1. **Implement Smart ID Resolution**: Create a document ID resolution layer that handles both base IDs and chunk IDs
2. **Add Chunk-Aware Operations**: Enhance ChromaDB service methods to operate on all chunks of a document
3. **Maintain Backward Compatibility**: Ensure existing chunk-specific operations still work
4. **Fix Affected Tests**: Update tests to work with the new chunk-aware system

### **Success Criteria:**
```
TestComplexDocumentLifecycleAcrossBranches: PASS ✅
- doc3 deletion succeeds (all chunks removed)
- Document operations work with base IDs
- Chunk-specific operations still function
- No silent failures in ID operations
```

### **Implementation Requirements:**

1. **Core ID Resolution Service**:
   ```csharp
   public interface IDocumentIdResolver
   {
       // Expand base document ID to all chunk IDs
       Task<List<string>> ExpandToChunkIds(string collectionName, string documentId);
       
       // Extract base document ID from chunk ID
       string ExtractBaseDocumentId(string chunkId);
       
       // Check if ID is a chunk ID or base ID
       bool IsChunkId(string id);
       
       // Get all chunk IDs for multiple base document IDs
       Task<List<string>> ExpandMultipleToChunkIds(string collectionName, List<string> documentIds);
   }
   ```

2. **Enhanced ChromaPythonService Methods**:
   ```csharp
   public async Task<bool> DeleteDocumentsAsync(string collectionName, List<string> ids, bool expandChunks = true)
   {
       if (expandChunks)
       {
           // Expand each ID to include all its chunks
           var expandedIds = await _idResolver.ExpandMultipleToChunkIds(collectionName, ids);
           // Delete all expanded IDs
       }
       else
       {
           // Direct deletion for backward compatibility
       }
   }
   
   public async Task<bool> UpdateDocumentsAsync(string collectionName, List<string> ids, 
       List<string>? documents = null, List<Dictionary<string, object>>? metadatas = null, 
       bool expandChunks = true, bool markAsLocalChange = true)
   {
       // Similar expansion logic for updates
   }
   ```

3. **ID Resolution Implementation Strategy**:
   - **Pattern Recognition**: Use regex `^(.+)_chunk_(\d+)$` to identify chunk IDs
   - **Query Expansion**: When given `doc3`, query for all IDs matching `doc3_chunk_*`
   - **Metadata Inspection**: Use chunk metadata to determine total chunks
   - **Caching**: Cache chunk ID mappings for performance

4. **Chunk Management Utilities**:
   ```csharp
   public static class ChunkManagementUtility
   {
       // Get all chunk IDs for a base document
       public static async Task<List<string>> GetAllChunkIds(
           IChromaDbService chromaService, 
           string collectionName, 
           string baseDocumentId)
       {
           // Query ChromaDB for all documents with IDs starting with baseDocumentId_chunk_
           // OR use metadata query where base_doc_id = baseDocumentId
       }
       
       // Determine if operation should expand chunks
       public static bool ShouldExpandChunks(string id)
       {
           // Return true if ID doesn't contain _chunk_ pattern
           return !id.Contains("_chunk_");
       }
   }
   ```

### **Technical Implementation Details:**

1. **ChromaDB Query Approach**:
   - Use `where` parameter with regex/pattern matching if supported
   - Alternative: Get all documents and filter client-side
   - Optimal: Store `base_doc_id` in metadata for efficient querying

2. **Backward Compatibility**:
   - Add `expandChunks` parameter (default: true) to maintain existing behavior option
   - Existing tests using chunk IDs directly continue to work
   - New behavior becomes default for better developer experience

3. **Performance Optimization**:
   - Batch chunk operations to minimize round trips
   - Use metadata queries when possible
   - Consider adding index on base_doc_id metadata field

4. **Error Handling**:
   - Log warnings when no chunks found for base ID
   - Provide clear error messages for ID format issues
   - Handle partial chunk operations gracefully

### **Test Updates Required:**

1. **Primary Fix - BranchSwitchingIntegrationTests.cs**:
   ```csharp
   // Line 493 - Current (failing):
   await _chromaService.DeleteDocumentsAsync("alpha", new List<string> { "doc2" });
   
   // No change needed - will work with chunk expansion
   // OR explicitly use base ID behavior:
   await _chromaService.DeleteDocumentsAsync("alpha", new List<string> { "doc2" }, expandChunks: true);
   ```

   ```csharp
   // Line 621 - Current (failing):
   await _chromaService.DeleteDocumentsAsync("alpha", new List<string> { "doc3" });
   
   // No change needed - will work with chunk expansion
   ```

2. **Additional Test Scenarios**:
   ```csharp
   [Test]
   public async Task DeleteDocument_WithBaseId_DeletesAllChunks()
   {
       // Add document that creates multiple chunks
       // Delete using base ID
       // Verify all chunks are removed
   }
   
   [Test]
   public async Task UpdateDocument_WithBaseId_UpdatesAllChunks()
   {
       // Add document with multiple chunks
       // Update using base ID
       // Verify all chunks are updated
   }
   
   [Test]
   public async Task GetDocument_WithBaseId_RetrievesAllChunks()
   {
       // Add document with multiple chunks
       // Get using base ID
       // Verify all chunks are returned
   }
   ```

### **Migration Strategy:**

1. **Phase 1**: Implement ID resolver without changing existing methods
2. **Phase 2**: Add optional chunk expansion to methods with default true
3. **Phase 3**: Update tests to verify chunk-aware behavior
4. **Phase 4**: Optimize performance with metadata queries

### **Validation Process:**
1. Verify `TestComplexDocumentLifecycleAcrossBranches` passes
2. Test document operations with varying chunk counts (0, 1, many)
3. Confirm backward compatibility with chunk-specific operations
4. Validate performance with large documents (many chunks)
5. Ensure no regression in existing tests

## **Expected Outcome**
Document ID operations become chunk-aware and robust:
- Base document IDs automatically expand to all chunks
- No more silent failures due to ID mismatches
- Improved developer experience with intuitive ID handling
- Maintained backward compatibility for specific chunk operations
- All tests pass with the new chunk-aware system

**Priority**: **Critical** - Current ID mismatch causes silent data integrity failures throughout the system.

## **Files to be Modified**
- `multidolt-mcp/Services/ChromaPythonService.cs` - Add chunk-aware ID expansion to methods
- `multidolt-mcp/Services/IChromaDbService.cs` - Update interface with optional expandChunks parameter
- `multidolt-mcp/Services/DocumentIdResolver.cs` - NEW: Implement ID resolution service
- `multidolt-mcp/Utilities/ChunkManagementUtility.cs` - NEW: Chunk management utilities
- `multidolt-mcp/Tools/ChromaDeleteDocumentsTool.cs` - Update to use chunk expansion
- `multidolt-mcp/Tools/ChromaUpdateDocumentsTool.cs` - Update to use chunk expansion
- `multidolt-mcp-testing/IntegrationTests/BranchSwitchingIntegrationTests.cs` - Verify fixes work
- `multidolt-mcp-testing/IntegrationTests/ChunkAwareOperationsTests.cs` - NEW: Comprehensive chunk tests

## **Implementation Notes**
- Consider making chunk expansion configurable via settings
- Document the chunk ID pattern in code comments
- Add logging for chunk expansion operations for debugging
- Consider future enhancement: automatic chunk re-assembly for GetDocuments

## **Risk Mitigation**
- Extensive testing with various chunk configurations
- Gradual rollout with feature flag if needed
- Clear documentation of behavior changes
- Maintain ability to disable chunk expansion for troubleshooting

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-69-C8' following the established pattern.