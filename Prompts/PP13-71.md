- IssueID = PP13-71
- Please read 'Prompts/BasePrompt.md' first for general context
- The `PreviewDoltMerge` tool fails to properly identify individual document-level conflicts during merge preview operations. This is a critical issue that undermines the tool's ability to provide actionable conflict resolution guidance.
- For context please read:
	- The issue report at 'Examples/260109_MergePreviewIssue.md' - detailed reproduction steps and expected vs actual behavior
	- The `PreviewDoltMergeTool.cs` implementation that orchestrates merge previews
	- The `ConflictAnalyzer.cs` service that performs conflict detection
	- The `DoltCli.cs` methods `PreviewMergeConflictsAsync` and `GetConflictDetailsAsync`
- This assignment focuses on implementing a robust document-level conflict detection system for the merge preview tool.

## **Problem Summary**

When two branches modify the same documents from a common ancestor, the merge preview returns:
- **Single generic conflict** instead of per-document conflicts
- **Empty collection and document IDs** (`collection: ""`, `document_id: ""`)
- **Incorrect auto-resolvable flag** (`true` when both branches made different changes to same content)
- **Missing content diff information** (no ours/theirs/base content)
- **Inflated change counts** (`documents_modified: 5`, `collections_affected: 3` instead of 2 and 1)

## **Root Cause Analysis**

### **Issue 1: Table-Level vs Row-Level Conflict Detection**
**Location**: `ConflictAnalyzer.cs:52-59`
```csharp
conflictSummaryJson = await _doltCli.PreviewMergeConflictsAsync(sourceBranch, targetBranch);
```
The `DOLT_PREVIEW_MERGE_CONFLICTS_SUMMARY` function returns table-level conflicts, not document/row-level conflicts. The fallback returns `"[]"` (empty array), providing no conflict information.

### **Issue 2: No Three-Way Merge Analysis**
**Location**: `ConflictAnalyzer.cs:516-522`
```csharp
private async Task<string> FallbackConflictAnalysis(string sourceBranch, string targetBranch)
{
    _logger.LogDebug("Using fallback conflict analysis");
    return "[]";  // No actual analysis performed!
}
```
The fallback is a stub that returns no conflicts. There's no implementation to:
1. Find the merge base commit
2. Compare base → source changes
3. Compare base → target changes
4. Identify overlapping document modifications

### **Issue 3: Schema/Internal Tables in Counts**
**Location**: `ConflictAnalyzer.cs:1028-1038`
```csharp
var tablesResult = await ExecuteDoltCommandAsync("diff", "--name-only", mergeBase, sourceBranch);
// All tables counted including internal ones
previewInfo.CollectionsAffected = affectedTables.Count;
```
The diff statistics include internal schema tables (`chroma_sync_state`, `document_sync_log`, `sync_operations`) leading to inflated counts.

### **Issue 4: Missing Document Content Extraction**
The conflict parser doesn't extract actual document content for `ours_content`, `theirs_content`, and `base_content` fields needed for informed conflict resolution.

## **Assignment Objectives**

### **Primary Goals:**
1. **Implement Document-Level Conflict Detection**: Create proper three-way merge analysis that identifies per-document conflicts
2. **Populate Conflict Details**: Extract and populate collection name, document ID, and content for each conflict
3. **Fix Auto-Resolvable Logic**: When both branches modify the same document differently, mark as NOT auto-resolvable
4. **Filter Internal Tables**: Exclude schema/sync tables from change counts and affected collections
5. **Provide Content Diffs**: Include base, ours, and theirs content for each document conflict

### **Success Criteria:**
Given the test scenario from the issue report:
- Two branches from same base
- Both modify `someid1` and `someid2` differently
- Merge preview must return:

```json
{
  "total_conflicts": 2,
  "auto_resolvable": 0,
  "requires_manual": 2,
  "affected_collections": ["main"],
  "changes_preview": {
    "documents_modified": 2,
    "collections_affected": 1
  },
  "conflicts": [
    {
      "collection": "main",
      "document_id": "someid1",
      "auto_resolvable": false,
      "ours_content": "...branch 2",
      "theirs_content": "...branch 1",
      "base_content": "...original"
    },
    {
      "collection": "main",
      "document_id": "someid2",
      "auto_resolvable": false,
      // ... similar
    }
  ]
}
```

## **Implementation Requirements**

### **Phase 1: Three-Way Document Diff Implementation**
**Files**: `ConflictAnalyzer.cs`

1. **Implement `GetDocumentChangesFromBase`**:
   ```csharp
   private async Task<Dictionary<string, DocumentChange>> GetDocumentChangesFromBase(
       string mergeBase,
       string branch,
       string collection)
   ```
   - Query documents at merge base commit
   - Query documents at branch head
   - Compare and identify adds, modifies, deletes

2. **Implement `DetectDocumentConflicts`**:
   ```csharp
   private async Task<List<DetailedConflictInfo>> DetectDocumentConflicts(
       string mergeBase,
       string sourceBranch,
       string targetBranch)
   ```
   - Get changes from base → source
   - Get changes from base → target
   - Find overlapping document IDs with different changes
   - Create DetailedConflictInfo for each overlap

3. **Replace `FallbackConflictAnalysis`**:
   - Call `DetectDocumentConflicts` instead of returning empty array
   - Use Dolt SQL queries to access historical document states

### **Phase 2: Content Extraction for Conflicts**
**Files**: `ConflictAnalyzer.cs`, `DoltCli.cs`

1. **Implement `GetDocumentAtCommit`**:
   ```csharp
   public async Task<DocumentContent?> GetDocumentAtCommitAsync(
       string collection,
       string documentId,
       string commitHash)
   ```
   - Use Dolt's `AS OF` clause: `SELECT * FROM documents AS OF 'commit_hash' WHERE source_id = 'doc_id'`
   - Return content, metadata, and content_hash

2. **Populate Conflict Content**:
   - For each detected conflict:
     - `BaseContent` = document at merge base
     - `OursContent` = document at target branch
     - `TheirsContent` = document at source branch

### **Phase 3: Internal Table Filtering**
**Files**: `ConflictAnalyzer.cs`

1. **Define Internal Tables List**:
   ```csharp
   private static readonly HashSet<string> InternalTables = new()
   {
       "chroma_sync_state",
       "document_sync_log",
       "sync_operations",
       "local_changes",
       "collections"  // Consider if this should be user-facing
   };
   ```

2. **Filter in `GenerateMergePreview`**:
   - Exclude internal tables from `CollectionsAffected` count
   - Only count documents table changes for document metrics

### **Phase 4: Auto-Resolvable Logic Fix**
**Files**: `ConflictAnalyzer.cs`

1. **Update `CanAutoResolveConflictAsync`**:
   ```csharp
   private async Task<bool> CanAutoResolveConflictAsync(DetailedConflictInfo conflict)
   {
       // NOT auto-resolvable if:
       // - Both branches modified the same document content differently
       // - Document was deleted in one branch and modified in other

       // Auto-resolvable if:
       // - Only one branch modified the document
       // - Both branches made identical changes
       // - One branch added, other didn't touch (fast-forward)
   }
   ```

### **Phase 5: Model Updates**
**Files**: `MergeModels.cs` (or create new `ConflictModels.cs`)

1. **Extend `DetailedConflictInfo`**:
   ```csharp
   public class DetailedConflictInfo
   {
       // Existing fields...

       // Add content fields
       public string? BaseContent { get; set; }
       public string? OursContent { get; set; }
       public string? TheirsContent { get; set; }
       public string? BaseContentHash { get; set; }
       public string? OursContentHash { get; set; }
       public string? TheirsContentHash { get; set; }
   }
   ```

2. **Update `PreviewDoltMergeTool`** response to include new fields

## **Technical Constraints**
- **DO NOT** modify the Dolt database schema
- **MAINTAIN** backward compatibility with existing tool callers
- **PRESERVE** existing merge execution functionality
- **USE** Dolt's `AS OF` clause for historical queries
- **FILTER** only user document collections (typically named by user, not `documents` table directly)

## **Validation Process**

### **Unit Tests to Create** (`ConflictAnalyzerTests.cs`)
1. `DetectDocumentConflicts_BothBranchesModifySameDoc_ReturnsConflict`
2. `DetectDocumentConflicts_OnlyOneBranchModifies_NoConflict`
3. `DetectDocumentConflicts_IdenticalChanges_AutoResolvable`
4. `FilterInternalTables_ExcludesSchemaTables`
5. `GetDocumentAtCommit_ReturnsHistoricalContent`

### **Integration Test to Create** (`MergePreviewIntegrationTests.cs`)
Based on the suggested test from the issue report:
```csharp
[Test]
public async Task PreviewMerge_WithConflictingDocumentModifications_ReturnsIndividualConflicts()
{
    // Implementation from issue report
}
```

### **Manual Validation**
Use the preserved test repository `pieter-prespective/newDMMSTest`:
1. Clone repository
2. Run `PreviewDoltMerge` with `mergetestbranch1` → `mergetestbranch2`
3. Verify response matches expected output from issue report

## **Files to Modify**
1. **`multidolt-mcp/Services/ConflictAnalyzer.cs`** - Core conflict detection logic
2. **`multidolt-mcp/Services/IConflictAnalyzer.cs`** - Interface updates if needed
3. **`multidolt-mcp/Services/DoltCli.cs`** - Add `GetDocumentAtCommitAsync` method
4. **`multidolt-mcp/Services/IDoltCli.cs`** - Interface update
5. **`multidolt-mcp/Models/MergeModels.cs`** - Extend conflict models
6. **`multidolt-mcp/Tools/PreviewDoltMergeTool.cs`** - Response structure updates

## **Files to Create**
1. **`multidolt-mcp-testing/UnitTests/ConflictAnalyzerTests.cs`** - Unit tests (if not exists, expand)
2. **`multidolt-mcp-testing/IntegrationTests/PP13_71_MergePreviewDocumentConflictTests.cs`** - Integration tests

## **Expected Outcome**
The `PreviewDoltMerge` tool accurately:
- Detects individual document-level conflicts
- Populates collection name and document ID for each conflict
- Correctly identifies auto-resolvable vs manual resolution required
- Provides base/ours/theirs content for informed decision making
- Reports accurate change counts excluding internal tables
- Enables users to make informed merge decisions

**Priority**: **High** - This tool is essential for collaborative workflows where multiple team members may modify the same documents.

## **Dolt SQL Reference**

### **Query Documents at Specific Commit**
```sql
SELECT source_id, content, content_hash, metadata
FROM documents AS OF 'commit_hash'
WHERE source_id = 'document_id'
```

### **Get Merge Base**
```bash
dolt merge-base branch1 branch2
```

### **Diff Between Commits (for specific table)**
```sql
SELECT * FROM dolt_diff('commit1', 'commit2', 'documents')
```

### **Get All Changes in a Table Between Commits**
```sql
SELECT diff_type, from_source_id, to_source_id, from_content, to_content
FROM dolt_diff('base_commit', 'branch_commit', 'documents')
```

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-71' following the established pattern.
