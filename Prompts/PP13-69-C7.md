- IssueID = PP13-69-C7
- Please read 'Prompts/BasePrompt.md' first for general context
- Critical synchronization bug identified: ChromaDB retains stale documents when switching between branches, causing data contamination across branch boundaries. This affects production reliability and data integrity.
- For context please read:
	- The PP13-69 architecture overview in 'Prompts/pp13-69.md' - the foundational design for SQLite sync state architecture
	- The PP13-69-C6 investigation logged in the chroma design planning database - comprehensive state isolation framework implementation
	- The root cause analysis from the investigation revealing additive-only sync behavior
	- The test failure pattern in TestComplexDocumentLifecycleAcrossBranches showing doc4 contamination
- This assignment specifically focuses on fixing the fundamental ChromaDB synchronization logic to properly handle document removal when switching branches:

## **Root Cause Analysis - ChromaDB Stale Document Retention**

### **Issue: Additive-Only Synchronization (Critical)**
**Test**: `TestComplexDocumentLifecycleAcrossBranches`
**Problem**: When switching from feature-a (has doc4) to feature-b-lifecycle (shouldn't have doc4), doc4 remains in ChromaDB
**Location**: `SyncManagerV2.SyncChromaToMatchBranch()` and related sync methods
**Root Cause**: Sync process only adds/updates documents but never removes documents that don't exist in target branch

### **Contamination Sequence Identified:**
1. **feature-b-lifecycle** correctly has doc1, doc2(modified), doc5 ✅
2. Switch to **main** (doc1, doc2, doc3) ✅
3. Switch to **feature-a** (doc1, doc3, doc4) ✅
4. Switch back to **feature-b-lifecycle** - ChromaDB retains doc4 from feature-a ❌
5. Result: 4 documents instead of 3

### **Impact Analysis:**
- **Data Integrity**: Documents from one branch appear in another
- **User Trust**: Incorrect document counts and unexpected content
- **Test Reliability**: State isolation tests fail consistently
- **Production Risk**: Branch switching corrupts working sets

## **Assignment Objectives**

### **Primary Goals:**
1. **Implement Differential Sync**: Add document removal logic to synchronization
2. **Fix SyncChromaToMatchBranch**: Ensure ChromaDB exactly matches Dolt state
3. **Preserve Performance**: Maintain efficient sync operations
4. **Comprehensive Testing**: Validate fix across multiple scenarios

### **Success Criteria:**
```
TestComplexDocumentLifecycleAcrossBranches: PASS ✅
- feature-b-lifecycle has exactly 3 documents (not 4)
- No doc4 contamination from feature-a
- All branch switches maintain correct document sets
```

### **Implementation Requirements:**

1. **Core Sync Fix in SyncManagerV2**:
   ```csharp
   private async Task SyncChromaToMatchBranch(string targetBranch)
   {
       // CURRENT: Only syncs documents that exist in Dolt
       // REQUIRED: Also remove documents that shouldn't exist
       
       // Step 1: Get documents that SHOULD exist (from Dolt)
       var doltDocuments = await GetDoltDocumentIds(collection);
       
       // Step 2: Get documents that DO exist (in ChromaDB)  
       var chromaDocuments = await GetChromaDocumentIds(collection);
       
       // Step 3: Identify documents to remove
       var toRemove = chromaDocuments.Except(doltDocuments);
       
       // Step 4: Remove stale documents from ChromaDB
       if (toRemove.Any())
           await _chromaService.DeleteDocumentsAsync(collection, toRemove);
       
       // Step 5: Continue with normal sync
       await FullSyncAsync(collection);
   }
   ```

2. **Enhance FullSyncAsync Method**:
   - Add parameter for sync mode (additive vs. exact)
   - Implement document removal before sync when in exact mode
   - Use exact mode for branch checkout operations
   - Use additive mode for incremental syncs

3. **Update ProcessCheckoutAsync**:
   - Ensure SyncChromaToMatchBranch uses exact sync mode
   - Add logging for document removal operations
   - Track removed document count in SyncResultV2

4. **Performance Optimization**:
   - Batch document removal operations
   - Only perform differential sync when branch changes
   - Cache document lists where appropriate

### **Technical Constraints:**
- **PRESERVE** PP13-69 SQLite sync state architecture
- **MAINTAIN** backward compatibility with existing sync operations
- **ENSURE** no data loss - only remove genuinely stale documents
- **MINIMIZE** performance impact on large document sets

### **Testing Requirements:**

1. **Fix Existing Test**:
   - TestComplexDocumentLifecycleAcrossBranches must pass
   - Verify doc4 doesn't contaminate feature-b-lifecycle

2. **Add Specific Test Cases**:
   ```csharp
   [Test]
   public async Task BranchSwitch_RemovesStaleDocuments_MaintainsDataIntegrity()
   {
       // Create branch with doc1, doc2, doc3, doc4
       // Switch to branch with only doc1, doc2
       // Verify doc3 and doc4 are removed from ChromaDB
   }
   
   [Test]
   public async Task MultipleBranchSwitches_NoAccumulation_CorrectDocumentSets()
   {
       // Switch between 3+ branches with different document sets
       // Verify each branch has exactly its documents
   }
   ```

3. **Regression Testing**:
   - Run all PP13-69 test suites
   - Verify sync performance benchmarks
   - Ensure no impact on non-branch operations

### **Validation Process:**
1. Add diagnostic logging to track document removal
2. Verify ChromaDB state matches Dolt exactly after each branch switch
3. Test with branches having overlapping and non-overlapping document sets
4. Validate performance with large document collections (1000+ docs)
5. Ensure sync state tracking remains accurate

## **Expected Outcome**
Branch switching maintains perfect ChromaDB-Dolt synchronization:
- ChromaDB always exactly matches the current Dolt branch state
- No document contamination between branches
- Efficient differential sync operations
- Clear logging of document additions and removals

**Priority**: **Critical** - Current behavior causes data integrity issues in production scenarios.

## **Files to be Modified**
- `multidolt-mcp/Services/SyncManagerV2.cs` - Core sync logic enhancement
- `multidolt-mcp/Services/ISyncManagerV2.cs` - Interface updates if needed
- `multidolt-mcp/Models/SyncModels.cs` - Add tracking for removed documents
- `multidolt-mcp-testing/IntegrationTests/BranchSwitchingIntegrationTests.cs` - Verify fix and add tests

## **Implementation Notes**
- Consider using transaction-like behavior for document removal
- Ensure proper error handling if removal fails
- Log all removal operations for audit trail
- Consider adding a "strict mode" flag for exact synchronization

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-69-C7' following the established pattern.