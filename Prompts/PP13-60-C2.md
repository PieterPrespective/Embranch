- IssueID = PP13-60-C2
- Please read 'Prompts/BasePrompt.md' first for general context
- This is a continuation of PP13-60-C1 which implemented the systemic fix for update/delete document sync issues in multidolt-mcp

## Background

The PP13-60-C1 implementation successfully addressed the core synchronization issues for update and delete operations by:
1. Creating an external SQLite deletion tracking database
2. Enhancing ChromaUpdateDocumentsTool to set is_local_change flags and content hashes
3. Enhancing ChromaDeleteDocumentsTool to track deletions in the external database
4. Updating ChromaToDoltDetector to include deletion tracking in detection
5. Creating comprehensive integration tests (UpdateDeleteSyncBasicTests)

However, the integration tests are currently failing due to critical initialization issues discovered during testing.

## Problem Statement

The UpdateDeleteSyncBasicTests are hanging/crashing because of missing asynchronous initialization steps that are present in working tests like MultiCollectionBranchSyncTests. Specifically:

1. **DoltCli is never initialized** - The test creates DoltCli through dependency injection but never calls `await doltCli.InitAsync()`, leaving the Dolt repository uninitialized
2. **Service initialization order is incorrect** - Services dependent on Dolt are being used before Dolt is ready
3. **Path configuration inconsistencies** - Using separate paths for data and repository may cause issues
4. **Complex DI setup** - Overly complex service provider configuration compared to working tests

## Assignment Objectives

Fix the UpdateDeleteSyncBasicTests to properly initialize all services and successfully run the PP13-60-C1 test scenarios. This involves:
1. Correcting the service initialization flow
2. Ensuring proper async initialization of Dolt
3. Simplifying the DI configuration where appropriate
4. Verifying all three test methods execute successfully

## Detailed Requirements

### 1. Fix Dolt Initialization

**Current Issue:**
- Lines 45-58 in UpdateDeleteSyncBasicTests.cs have Dolt initialization commented out
- DoltCli is retrieved from DI but never initialized with `InitAsync()`

**Required Changes:**
- After retrieving DoltCli from the service provider, call `await _doltCli.InitAsync()`
- Ensure this happens BEFORE any other services that depend on Dolt are used
- Add proper Windows path handling for DoltExecutablePath

### 2. Correct Service Initialization Order

**Current Issue:**
- InitializeTestEnvironmentAsync() is called without Dolt being initialized first
- Deletion tracker tries to work with non-existent Dolt database

**Required Changes:**
```csharp
// Correct order:
1. Get DoltCli from DI
2. await doltCli.InitAsync()
3. await deletionTracker.InitializeAsync()
4. Create ChromaDB collections
```

### 3. Simplify ChromaDB Service Creation

**Current Issue:**
- Complex factory pattern with IOptions wrapping (lines 251-261)
- Different from working MultiCollectionBranchSyncTests pattern

**Required Changes:**
- Consider direct instantiation like MultiCollectionBranchSyncTests
- Or ensure the factory pattern properly handles all initialization

### 4. Path Configuration Alignment

**Current Issue:**
- UpdateDeleteSyncBasicTests uses separate `_tempDataPath` and `_tempRepoPath`
- MultiCollectionBranchSyncTests uses single `_tempDir`

**Required Changes:**
- Ensure DoltConfiguration.RepositoryPath points to the correct initialized directory
- Verify ChromaDataPath and DataPath are properly configured
- Consider consolidating to single temp directory pattern

### 5. Complete DoltConfiguration

**Current Issue:**
- Missing CommandTimeoutMs and EnableDebugLogging settings
- Missing platform-specific executable path handling

**Required Changes:**
```csharp
var doltConfig = new DoltConfiguration
{
    DoltExecutablePath = Environment.OSVersion.Platform == PlatformID.Win32NT 
        ? @"C:\Program Files\Dolt\bin\dolt.exe" 
        : "dolt",
    RepositoryPath = _tempRepoPath,
    CommandTimeoutMs = 30000,
    EnableDebugLogging = true
};
```

## Test Scenarios to Verify

After fixing initialization, ensure all three test methods work:

### 1. UpdateDocumentTool_SetsLocalChangeFlag
- Should add a document
- Update it through ChromaUpdateDocumentsTool
- Verify is_local_change flag and content_hash are set

### 2. DeleteDocumentTool_TracksInDeletionDatabase (currently commented out)
- Should add a document
- Delete it through ChromaDeleteDocumentsTool
- Verify deletion is tracked in SQLite database
- Uncomment and fix this test

### 3. DeletionDetector_FindsTrackedDeletions
- Should add and delete a document
- Use ChromaToDoltDetector to detect the deletion
- Verify deletion appears in detection results

## Success Criteria

1. All three test methods in UpdateDeleteSyncBasicTests pass successfully
2. No hanging or crashing during test execution
3. Proper initialization sequence is documented in code comments
4. Tests complete within reasonable time (< 30 seconds each)
5. Clean teardown with no orphaned resources

## Implementation Notes

1. Reference MultiCollectionBranchSyncTests.Setup() as the working example
2. Ensure all async operations are properly awaited
3. Add appropriate logging to track initialization sequence
4. Consider adding timeout attributes to prevent indefinite hanging
5. Verify ChromaDB Python context initialization is working

## Files to Modify

Primary file:
- `multidolt-mcp-testing\IntegrationTests\UpdateDeleteSyncBasicTests.cs`

Reference files (do not modify, use for comparison):
- `multidolt-mcp-testing\IntegrationTests\MultiCollectionBranchSyncTests.cs`
- `multidolt-mcp\Services\DoltCli.cs`
- `multidolt-mcp\Services\SqliteDeletionTracker.cs`

## Testing Approach

1. First, get the simplest test (UpdateDocumentTool_SetsLocalChangeFlag) working
2. Then uncomment and fix DeleteDocumentTool_TracksInDeletionDatabase
3. Finally, ensure DeletionDetector_FindsTrackedDeletions works
4. Run all tests together to verify no interference
5. Run tests individually with verbose logging to debug any remaining issues

## Deliverables

1. Fixed UpdateDeleteSyncBasicTests.cs with proper initialization
2. All three tests passing
3. Clear code comments explaining the initialization sequence
4. Brief summary of what was changed and why