# IssueID = PP13-58

## Dolt Working Directory State Consistency Fix

- Please read 'Prompts/BasePrompt.md' first for general context.
- Please see the logs in chroma on PP13-57 (first 4 phases, 5th phase is not yet implemented), this issue is effectively a continuation on that issue - specifically focused on fixing the performance tests.

## Problem Summary

A critical data consistency issue has been identified in the Dolt-ChromaDB synchronization system. Document query operations are inconsistently reading from different Dolt states (working directory vs. committed state), causing sync validation failures and incorrect change detection.

## Root Cause Analysis

### The Issue
During synchronization operations, different query methods read from different Dolt states:

1. **Document Retrieval (`GetAllDocumentsAsync`)**: Reads from Dolt **working directory** (uncommitted changes)
2. **Document Validation (`GetDocumentCountAsync`)**: Reads from Dolt **working directory** (uncommitted changes) 
3. **Reset Operations (`dolt reset --hard HEAD`)**: Discards working directory changes, reverting to **committed state**
4. **Branch Operations**: Can leave working directory in inconsistent state relative to committed history

### Failure Sequence
1. Sync operation reads documents from working directory ✅
2. Metadata updates create uncommitted changes in `chroma_sync_state` table ⚠️
3. Reset operation discards all uncommitted changes including document data ❌
4. Validation queries find empty committed state instead of expected documents ❌
5. Tests fail with "expected 3 documents, found 0" errors ❌

### Evidence
- Test databases show untracked tables: `documents`, `chroma_sync_state`, `collections`
- Manual testing confirms: committed state has documents ✅, post-reset state has no tables ❌
- SQL query timing analysis shows queries execute correctly but operate on different states

## Requirement Specification

### Core Principle
**All document operations within a single workflow must operate on the same Dolt state** (either working directory OR committed state, never mixed).

### Required Implementation

#### Phase 1: Immediate State Consistency Fix
1. **Implement `EnsureCleanWorkingDirectoryAsync()` method**
   - Check Dolt working directory status
   - Auto-commit pending changes OR reset to clean state based on operation context
   - Ensure all subsequent queries operate on committed state

2. **Update All Document Query Methods**
   - `GetAllDocumentsAsync()`
   - `GetDocumentCountAsync()`  
   - `GetAvailableCollectionNamesAsync()`
   - Any other methods that query the `documents` table

3. **Modify Sync Operations Flow**
   - Call state consistency check before starting sync operations
   - Ensure metadata updates are committed as part of sync transaction
   - Prevent reset operations from discarding uncommitted document changes

#### Phase 2: Transaction Management Enhancement
1. **Implement Transaction Boundaries**
   ```csharp
   // Pseudo-code structure
   using var transaction = await _dolt.BeginTransactionAsync();
   try 
   {
       var documents = await GetAllDocumentsAsync(collectionName);
       // ... sync operations
       await UpdateSyncStateAsync(...);
       await transaction.CommitAsync();
   }
   catch { await transaction.RollbackAsync(); throw; }
   ```

2. **Add Explicit State Management**
   - Add `DoltQueryMode` enum (WorkingDirectory, CommittedState, Auto)
   - Modify query methods to accept mode parameter
   - Implement mode detection and consistency enforcement

#### Phase 3: Enhanced Error Handling & Validation
1. **Improve Error Messages**
   - Add Dolt state information to error logs
   - Detect and report state inconsistencies clearly
   - Provide actionable guidance for resolution

2. **Add State Validation Checks**
   - Verify working directory status before operations
   - Add consistency checks between query results
   - Implement state recovery mechanisms

### Implementation Approach

#### Option A: Conservative (Recommended for Initial Fix)
- Always ensure clean committed state before document operations
- Auto-commit pending changes when necessary
- Provides immediate stability with minimal risk

#### Option B: Transactional (Long-term Solution)  
- Implement explicit transaction boundaries
- Better performance through reduced commits
- Requires more extensive testing

#### Option C: Hybrid State Management
- Support both working directory and committed state operations
- Explicit mode selection per operation
- Maximum flexibility but higher complexity

## Test Requirements

### Failing Tests to Fix
1. **`TestFailureRecovery`** (Phase4PerformanceTests)
   - Should pass after implementing state consistency
   - Verify reset operations don't break subsequent sync operations
   
2. **All DocumentStateValidation tests** (should remain passing)
   - Ensure fixes don't regress existing functionality
   - Validate branch switching continues to work correctly

### New Tests to Add
1. **`DoltStateConsistencyTests`**
   - Test document operations with uncommitted changes
   - Verify reset operations maintain data integrity
   - Test concurrent operations on same repository

2. **`TransactionBoundaryTests`** (if implementing Option B)
   - Verify rollback behavior on failures
   - Test nested transaction scenarios

### Integration Tests
- Update existing integration tests to use consistent state management
- Ensure all multi-user scenarios work correctly
- Verify performance characteristics remain acceptable

## Success Criteria

### Primary Goals
1. ✅ `TestFailureRecovery` passes consistently 
2. ✅ All existing DocumentStateValidation tests continue passing
3. ✅ No more "document count mismatch" errors in logs
4. ✅ Sync operations work reliably after reset/branch operations

### Quality Metrics  
1. **Reliability**: Tests pass >95% of the time
2. **Performance**: No significant degradation in sync operation speed
3. **Maintainability**: Clear separation between working directory and committed state operations
4. **Debuggability**: Comprehensive logging of Dolt state during operations

## Implementation Notes

### Files to Modify
1. **`DeltaDetectorV2.cs`**
   - Add state consistency methods
   - Update all document query methods
   
2. **`SyncManagerV2.cs`**  
   - Implement transaction boundaries for sync operations
   - Add state validation before operations
   
3. **`DoltCli.cs`** (if needed)
   - Add transaction support methods
   - Enhance status checking capabilities

### Backwards Compatibility
- Maintain existing method signatures where possible
- Add optional parameters for new functionality  
- Ensure existing tests continue to pass

### Testing Strategy
1. **Unit Tests**: Test individual state management methods
2. **Integration Tests**: Test full sync workflows with state changes
3. **Stress Tests**: Verify behavior under concurrent operations
4. **Manual Validation**: Use actual Dolt commands to verify consistency

This fix will resolve the fundamental data consistency issue and provide a solid foundation for reliable Dolt-ChromaDB synchronization operations.